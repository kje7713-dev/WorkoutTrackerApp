default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # App Store Connect API key from file created by GitHub Actions
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: "fastlane/AuthKey.p8",
      in_house: false
    )

    is_ci = ENV["CI"] == "true"
    readonly =
      if ENV.key?("MATCH_READONLY")
        ENV["MATCH_READONLY"].to_s.downcase == "true"
      else
        is_ci
      end

    #############################################
    # CREATE TEMP KEYCHAIN FOR MATCH ON CI
    #############################################
    keychain_path = "/Users/runner/Library/Keychains/fastlane_tmp.keychain-db"
    keychain_password = ENV["MATCH_PASSWORD"]

    sh <<~CMD
      security create-keychain -p "#{keychain_password}" "#{keychain_path}"
      security set-keychain-settings -lut 21600 "#{keychain_path}"
      security list-keychains -s "#{keychain_path}" $(security list-keychains | sed 's/[",]//g')
      security unlock-keychain -p "#{keychain_password}" "#{keychain_path}"
    CMD
    #############################################

    match(
      type: "appstore",
      readonly: readonly,
      api_key: api_key,
      keychain_name: keychain_path,
      keychain_password: keychain_password
    )

    #############################################
    # FIND PROJECT / WORKSPACE RECURSIVELY
    #############################################

    # Allow explicit override if you want:
    workspace_override = ENV["IOS_WORKSPACE"]
    project_override   = ENV["IOS_PROJECT"]

    # Otherwise search the repo
    workspace_candidates = Dir["**/*.xcworkspace"]
      .reject { |p| p.include?("/Pods/") || p.include?("/Carthage/") }

    project_candidates = Dir["**/*.xcodeproj"]
      .reject { |p| p.include?("/Pods/") || p.include?("/Carthage/") }

    workspace = workspace_override || workspace_candidates.first
    project   = project_override   || project_candidates.first

    UI.message("Workspace candidates: #{workspace_candidates}")
    UI.message("Project candidates: #{project_candidates}")
    UI.message("Using workspace: #{workspace}") if workspace
    UI.message("Using project: #{project}") if project

    UI.user_error!(
      "No .xcworkspace or .xcodeproj found anywhere in repo. " \
      "Set IOS_WORKSPACE or IOS_PROJECT in secrets/env to point to it."
    ) unless workspace || project

    build_app(
      workspace: workspace,
      project: project,
      scheme: ENV["IOS_SCHEME"],
      export_method: "app-store",
      clean: true
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end
end