      scheme = ENV["IOS_SCHEME"] || "YourAppName"

      workspace = ENV["IOS_WORKSPACE"].to_s
      project   = ENV["IOS_PROJECT"].to_s

      # --- NEW: Generate Xcode project from project.yml ---
      sh("brew install xcodegen || true")
      sh("xcodegen generate")

      # Fallback to generated project if env vars not set
      if workspace.empty? && project.empty?
        project = "YourAppName.xcodeproj"
      end

      build_opts = {
        scheme: scheme,
        export_method: "app-store",
        clean: true,
        silent: false,
        export_team_id: ENV["APPLE_TEAM_ID"],
        export_options: {
          provisioningProfiles: {
            ENV["APP_IDENTIFIER"] => "match AppStore #{ENV['APP_IDENTIFIER']}"
          },
          teamID: ENV["APPLE_TEAM_ID"]
        },
        xcargs: [
          "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
          "CODE_SIGN_STYLE=Manual",
          "CODE_SIGN_IDENTITY='Apple Distribution'",
          "PROVISIONING_PROFILE_SPECIFIER='match AppStore #{ENV['APP_IDENTIFIER']}'",
          "INFOPLIST_KEY_UILaunchStoryboardName=LaunchScreen"
        ].join(" ")
      }

      if !workspace.empty?
        build_opts[:workspace] = workspace
      else
        build_opts[:project] = project
      end

      build_app(**build_opts)